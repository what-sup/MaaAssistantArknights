name: Sync master from upstream

on:
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: "Repository owner/name to sync from"
        required: false
        default: MaaAssistantArknights/MaaAssistantArknights
      upstream_branch:
        description: "Branch name to sync from upstream"
        required: false
        default: master
  schedule:
    - cron: "0 */3 * * *"

permissions:
  contents: write

concurrency:
  group: sync-master
  cancel-in-progress: true

jobs:
  merge-upstream:
    name: Merge upstream master
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.change_status.outputs.changed }}
      new_sha: ${{ steps.updated_head.outputs.sha }}
    env:
      BASE_BRANCH: master
      UPSTREAM_REPO: MaaAssistantArknights/MaaAssistantArknights
      UPSTREAM_BRANCH: master
      WORKFLOW_PAT: ${{ secrets.WORKFLOW_PAT }}

    steps:
      - name: Checkout master
        uses: actions/checkout@v5
        with:
          ref: master
          fetch-depth: 0

      - name: Apply manual inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "UPSTREAM_REPO=${{ github.event.inputs.upstream_repo || 'MaaAssistantArknights/MaaAssistantArknights' }}" >> "$GITHUB_ENV"
          echo "UPSTREAM_BRANCH=${{ github.event.inputs.upstream_branch || 'master' }}" >> "$GITHUB_ENV"

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Prepare local master
        run: |
          set -euo pipefail
          git checkout "$BASE_BRANCH"
          git pull --ff-only origin "$BASE_BRANCH"

      - name: Record base commit
        id: base_head
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Fetch upstream branch
        run: |
          set -euo pipefail
          git remote add upstream "https://github.com/${UPSTREAM_REPO}.git" 2>/dev/null || git remote set-url upstream "https://github.com/${UPSTREAM_REPO}.git"
          git fetch upstream "$UPSTREAM_BRANCH"

      - name: Fetch upstream tags
        run: |
          set -euo pipefail
          git fetch upstream --tags --force

      - name: Merge upstream changes
        run: |
          set -euo pipefail
          git merge --no-edit "upstream/${UPSTREAM_BRANCH}" || {
            echo "::error::Merge resulted in conflicts. Resolve manually and re-run the workflow."
            exit 1
          }
          git status -sb

      - name: Record updated commit
        id: updated_head
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Detect master changes
        id: change_status
        run: |
          if [ "${{ steps.base_head.outputs.sha }}" = "${{ steps.updated_head.outputs.sha }}" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push updated master
        if: steps.change_status.outputs.changed == 'true'
        run: |
          set -euo pipefail
          if [ -z "${WORKFLOW_PAT:-}" ]; then
            echo "::error::WORKFLOW_PAT secret is required to push changes (including workflow updates)"
            exit 1
          fi
          git push "https://x-access-token:${WORKFLOW_PAT}@github.com/${{ github.repository }}" "$BASE_BRANCH"


  master-build:
    name: Build synced master
    needs: merge-upstream
    if: needs.merge-upstream.result == 'success' && needs.merge-upstream.outputs.changed == 'true'
    uses: ./.github/workflows/master-build.yml
    with:
      ref: ${{ needs.merge-upstream.outputs.new_sha }}
      reason: Sync master workflow run ${{ github.run_id }}
    secrets: inherit
